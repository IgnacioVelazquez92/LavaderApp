{# templates/home_dashboard.html #}
{% extends "base_auth.html" %}
{% block title %}Panel ‚Äî Lavaderos{% endblock %}

{% block content %}
  {# Evitamos "with ... if ..." (Django no lo permite). Usamos bloques separados. #}

  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-3">
    <div>
      <h1 class="h3 mb-1">Panel</h1>

      {% if request.empresa_activa %}
        {% with suc_count=request.empresa_activa.sucursales.count %}
          <p class="text-body-secondary mb-0">
            Lavadero: <strong>{{ request.empresa_activa.nombre }}</strong>
            <span class="ms-2 text-muted">({{ suc_count }} {% if suc_count == 1 %}sucursal{% else %}sucursales{% endif %})</span>
          </p>
        {% endwith %}
      {% else %}
        <p class="text-body-secondary mb-0">Comenz√° creando tu lavadero.</p>
      {% endif %}
    </div>

    {% if request.empresa_activa and request.empresa_activa.sucursales.exists %}
      <div class="mt-3 mt-md-0">
        <form method="post" action="{% url 'org:selector' %}">
          {% csrf_token %}
          <div class="input-group input-group-sm">
            <label class="input-group-text" for="dashSucursalSelect">Sucursal</label>
            <select class="form-select" id="dashSucursalSelect" name="sucursal" onchange="this.form.submit()">
              {% for s in request.empresa_activa.sucursales.all %}
                <option value="{{ s.id }}" {% if request.session.sucursal_id == s.id %}selected{% endif %}>
                  {{ s.nombre }}
                </option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
    {% endif %}
  </div>

  {# === Estado 1: NO HAY EMPRESA === #}
  {% if not request.empresa_activa %}
    <div class="card border">
      <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between">
        <div class="me-md-3">
          <h2 class="h5 mb-1">Bienvenido üëã</h2>
          <p class="mb-0 text-body-secondary">Cre√° tu lavadero para configurar tu marca y continuar con el alta de la primera sucursal.</p>
        </div>
        <a href="{% url 'org:empresa_nueva' %}" class="btn btn-primary mt-3 mt-md-0">
          <i class="bi bi-building-add me-1"></i> Crear lavadero
        </a>
      </div>
    </div>
  {% endif %}

  {# === Estado 2: HAY EMPRESA PERO SIN SUCURSALES === #}
  {% if request.empresa_activa and not request.empresa_activa.sucursales.exists %}
    <div class="card border">
      <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between">
        <div class="me-md-3">
          <h2 class="h5 mb-1">Siguiente paso</h2>
          <p class="mb-0 text-body-secondary">
            Cre√° tu <strong>primera sucursal</strong> para empezar a operar.
          </p>
        </div>
        <a href="{% url 'org:sucursal_nueva' %}" class="btn btn-primary mt-3 mt-md-0">
          <i class="bi bi-pin-map-fill me-1"></i> Crear sucursal
        </a>
      </div>
    </div>
  {% endif %}

  {# === Estado 3: LISTO PARA OPERAR (empresa + >=1 sucursal) === #}
  {% if request.empresa_activa and request.empresa_activa.sucursales.exists %}
    <div class="row g-3">
      {# Acciones r√°pidas #}
      <div class="col-12 col-xl-6">
        <div class="card h-100 border">
          <div class="card-body">
            <h2 class="h6 mb-3">Acciones r√°pidas</h2>
            <div class="d-flex flex-wrap gap-2">
              <button type="button" class="btn btn-primary btn-sm" disabled data-bs-toggle="tooltip" data-bs-title="Pr√≥ximamente">
                <i class="bi bi-receipt me-1"></i> Nueva venta
              </button>
              <a class="btn btn-outline-primary btn-sm" href="{% url 'org:sucursal_nueva' %}">
                <i class="bi bi-pin-map me-1"></i> Nueva sucursal
              </a>
              <a class="btn btn-outline-primary btn-sm" href="{% url 'org:sucursales' %}">
                <i class="bi bi-list-ul me-1"></i> Ver sucursales
              </a>
              <a class="btn btn-outline-secondary btn-sm" href="{% url 'org:empresas' %}">
                <i class="bi bi-building me-1"></i> Editar lavadero
              </a>
            </div>
          </div>
        </div>
      </div>

      {# KPIs placeholder #}
      <div class="col-12 col-xl-6">
        <div class="card h-100 border">
          <div class="card-body">
            <h2 class="h6 mb-3">Resumen de hoy</h2>
            <div class="row g-3">
              <div class="col-6">
                <div class="border rounded p-3 h-100">
                  <div class="text-muted small">Ventas</div>
                  <div class="fs-4 fw-semibold">‚Äî</div>
                </div>
              </div>
              <div class="col-6">
                <div class="border rounded p-3 h-100">
                  <div class="text-muted small">Ingresos</div>
                  <div class="fs-4 fw-semibold">‚Äî</div>
                </div>
              </div>
              <div class="col-6">
                <div class="border rounded p-3 h-100">
                  <div class="text-muted small">Trabajos en curso</div>
                  <div class="fs-4 fw-semibold">‚Äî</div>
                </div>
              </div>
              <div class="col-6">
                <div class="border rounded p-3 h-100">
                  <div class="text-muted small">Clientes atendidos</div>
                  <div class="fs-4 fw-semibold">‚Äî</div>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <button type="button" class="btn btn-outline-secondary btn-sm" disabled data-bs-toggle="tooltip" data-bs-title="Pr√≥ximamente">
                <i class="bi bi-graph-up-arrow me-1"></i> Ver reportes
              </button>
            </div>
          </div>
        </div>
      </div>

      {# Tips / ayuda contextual #}
      <div class="col-12">
        <div class="card border">
          <div class="card-body">
            <h2 class="h6 mb-2">Sugerencias</h2>
            <ul class="mb-0 text-body-secondary">
              <li>Configur√° tus <em>precios</em> y <em>servicios</em></li>
              <li>Complet√° el <a href="{% url 'org:empresas' %}">perfil de tu lavadero</a> para una mejor presentaci√≥n.</li>
              <li>Agreg√° m√°s <a href="{% url 'org:sucursales' %}">sucursales</a> si tu negocio crece.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
<script>
  // Habilitar tooltips Bootstrap (para botones ‚ÄúPr√≥ximamente‚Äù)
  document.addEventListener('DOMContentLoaded', function () {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl)
    })
  });
</script>
{% endblock %}
