{% extends "base_auth.html" %}
{% load static %}

{% block title %}Vehículo {{ vehiculo.patente }}{% endblock %}

{% block content %}
<div class="container-fluid py-3">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div class="d-flex align-items-center gap-3">
      <div class="display-6 mb-0 fw-bold">{{ vehiculo.patente }}</div>
      {% if vehiculo.activo %}
        <span class="badge text-bg-success align-middle">Activo</span>
      {% else %}
        <span class="badge text-bg-secondary align-middle">Inactivo</span>
      {% endif %}
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'vehicles:list' %}">
        <i class="bi bi-arrow-left"></i> Volver al listado
      </a>
      <a class="btn btn-outline-primary" href="{% url 'vehicles:edit' vehiculo.pk %}?next={{ request.get_full_path|urlencode }}">
        <i class="bi bi-pencil-square"></i> Editar
      </a>
      {% if vehiculo.activo %}
        <form method="post" action="{% url 'vehicles:deactivate' vehiculo.pk %}" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <button type="submit" class="btn btn-outline-danger">
            <i class="bi bi-slash-circle"></i> Desactivar
          </button>
        </form>
      {% else %}
        <form method="post" action="{% url 'vehicles:activate' vehiculo.pk %}" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <button type="submit" class="btn btn-outline-success">
            <i class="bi bi-check-circle"></i> Activar
          </button>
        </form>
      {% endif %}
    </div>
  </div>

  <!-- Grid: Datos clave -->
  <div class="row g-3">
    <!-- Card: Identificación -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Identificación</span>
          {% if vehiculo.tipo %}
            <span class="badge text-bg-primary">{{ vehiculo.tipo.nombre }}</span>
          {% else %}
            <span class="badge text-bg-light text-body-secondary border">Sin tipo</span>
          {% endif %}
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-4 col-sm-3">Patente</dt>
            <dd class="col-8 col-sm-9"><code class="fs-6">{{ vehiculo.patente }}</code></dd>

            <dt class="col-4 col-sm-3">Marca</dt>
            <dd class="col-8 col-sm-9">{{ vehiculo.marca|default:"—" }}</dd>

            <dt class="col-4 col-sm-3">Modelo</dt>
            <dd class="col-8 col-sm-9">{{ vehiculo.modelo|default:"—" }}</dd>

            <dt class="col-4 col-sm-3">Año</dt>
            <dd class="col-8 col-sm-9">{{ vehiculo.anio|default:"—" }}</dd>

            <dt class="col-4 col-sm-3">Color</dt>
            <dd class="col-8 col-sm-9">
              {% if vehiculo.color %}<span class="badge rounded-pill text-bg-light border">{{ vehiculo.color }}</span>{% else %}—{% endif %}
            </dd>
          </dl>
        </div>
        <div class="card-footer small text-body-secondary">
          Guardado en <strong>{{ request.empresa_activa.nombre }}</strong>
        </div>
      </div>
    </div>

    <!-- Card: Propietario -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Propietario</span>
          <a href="{% url 'customers:detail' vehiculo.cliente.pk %}" class="btn btn-sm btn-outline-secondary">
            Ver cliente
          </a>
        </div>
        <div class="card-body">
          {% if vehiculo.cliente %}
            <div class="d-flex align-items-start gap-3">
              <div class="rounded-circle bg-light border d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                <i class="bi bi-person fs-4 text-body-secondary"></i>
              </div>
              <div class="flex-grow-1">
                <div class="fw-semibold">
                  {{ vehiculo.cliente.apellido }} {{ vehiculo.cliente.nombre }}
                  {% if not vehiculo.cliente.activo %}
                    <span class="badge text-bg-secondary ms-1">Cliente inactivo</span>
                  {% endif %}
                </div>
                <div class="text-body-secondary small">
                  {{ vehiculo.cliente.email|default:"—" }}{% if vehiculo.cliente.tel_wpp %} · {{ vehiculo.cliente.tel_wpp }}{% endif %}
                </div>
                {% comment %} En el futuro: chips con tags del cliente {% endcomment %}
              </div>
            </div>
          {% else %}
            <p class="mb-0 text-body-secondary">—</p>
          {% endif %}
        </div>
        <div class="card-footer small text-body-secondary">
          <i class="bi bi-info-circle"></i> Podés transferir este vehículo a otro cliente desde <em>Editar</em>.
        </div>
      </div>
    </div>

    <!-- Card: Notas -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header">
          <span class="fw-semibold">Notas</span>
        </div>
        <div class="card-body">
          {% if vehiculo.notas %}
            <p class="mb-0" style="white-space: pre-wrap;">{{ vehiculo.notas }}</p>
          {% else %}
            <p class="mb-0 text-body-secondary">Sin notas.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Card: Otros vehículos del cliente -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Otros vehículos de este cliente</span>
          <a class="btn btn-sm btn-primary" href="{% url 'vehicles:new' %}?next={{ request.get_full_path|urlencode }}">
            <i class="bi bi-plus-lg"></i> Agregar vehículo
          </a>
        </div>
        <div class="card-body">
          {% with otros=vehiculo.cliente.vehiculos.all %}
            {% if otros|length > 1 %}
              <div class="table-responsive">
                <table class="table align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Patente</th>
                      <th scope="col" class="d-none d-md-table-cell">Tipo</th>
                      <th scope="col">Marca / Modelo</th>
                      <th scope="col" class="text-center">Estado</th>
                      <th scope="col" class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for v in otros %}
                      {% if v.pk != vehiculo.pk %}
                      <tr>
                        <td><a class="text-decoration-none fw-semibold" href="{% url 'vehicles:detail' v.pk %}">{{ v.patente }}</a></td>
                        <td class="d-none d-md-table-cell">{{ v.tipo.nombre|default:"—" }}</td>
                        <td>
                          {% if v.marca or v.modelo %}
                            {{ v.marca|default:"" }}{% if v.marca and v.modelo %} {% endif %}{{ v.modelo|default:"" }}
                          {% else %}
                            <span class="text-body-secondary">—</span>
                          {% endif %}
                        </td>
                        <td class="text-center">
                          {% if v.activo %}
                            <span class="badge text-bg-success">Activo</span>
                          {% else %}
                            <span class="badge text-bg-secondary">Inactivo</span>
                          {% endif %}
                        </td>
                        <td class="text-end">
                          <a class="btn btn-sm btn-outline-primary" href="{% url 'vehicles:detail' v.pk %}">
                            Ver
                          </a>
                        </td>
                      </tr>
                      {% endif %}
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="mb-0 text-body-secondary">Este cliente no tiene otros vehículos registrados.</p>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>

    <!-- Card: Metadatos -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header">
          <span class="fw-semibold">Metadatos</span>
        </div>
        <div class="card-body small text-body-secondary">
          <div class="row">
            <div class="col-6">
              <div class="mb-1">Creado</div>
              <div><time datetime="{{ vehiculo.creado|date:'c' }}">{{ vehiculo.creado|date:"d/m/Y H:i" }}</time></div>
            </div>
            <div class="col-6">
              <div class="mb-1">Actualizado</div>
              <div><time datetime="{{ vehiculo.actualizado|date:'c' }}">{{ vehiculo.actualizado|date:"d/m/Y H:i" }}</time></div>
            </div>
          </div>
        </div>
        <div class="card-footer small text-body-secondary">
          <i class="bi bi-shield-check"></i> Tenant: <strong>{{ request.empresa_activa.nombre }}</strong>
        </div>
      </div>
    </div>

    <!-- Placeholder: Historial (para futuras integraciones) -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <span class="fw-semibold">Historial</span>
          <span class="badge text-bg-light border text-body-secondary">Próximamente</span>
        </div>
        <div class="card-body text-body-secondary">
          Acá vas a ver lavados/servicios, ventas y notificaciones relacionadas a este vehículo.
        </div>
      </div>
    </div>

  </div> <!-- /row -->

</div>
{% endblock %}
