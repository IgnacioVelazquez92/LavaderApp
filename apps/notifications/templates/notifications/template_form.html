{% extends "base_auth.html" %}
{% load static %}

{% block title %}
  {% if form.instance.pk %}Editar plantilla{% else %}Nueva plantilla{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h3 mb-0">{% if form.instance.pk %}Editar plantilla{% else %}Nueva plantilla{% endif %}</h1>
      <p class="text-muted mb-0">Configurá las variables y el cuerpo del mensaje a enviar por Email o WhatsApp.</p>
    </div>
    <div>
      <a href="{% url 'notifications:templates_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Volver
      </a>
    </div>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}
    <div class="card shadow-sm">
      <div class="card-body">
        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label for="{{ form.clave.id_for_label }}" class="form-label fw-semibold">Clave</label>
            {{ form.clave }}
            {% if form.clave.errors %}
              <div class="invalid-feedback d-block">{{ form.clave.errors|striptags }}</div>
            {% else %}
              <div class="form-text">Identificador único por empresa. Ej.: <code>ready_to_pickup_email</code>.</div>
            {% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label for="{{ form.canal.id_for_label }}" class="form-label fw-semibold">Canal</label>
            {{ form.canal }}
            {% if form.canal.errors %}
              <div class="invalid-feedback d-block">{{ form.canal.errors|striptags }}</div>
            {% else %}
              <div class="form-text">Seleccioná Email o WhatsApp.</div>
            {% endif %}
          </div>
        </div>

        <div class="mt-3">
          <label for="{{ form.asunto_tpl.id_for_label }}" class="form-label fw-semibold">Asunto (solo para Email)</label>
          {{ form.asunto_tpl }}
          {% if form.asunto_tpl.errors %}
            <div class="invalid-feedback d-block">{{ form.asunto_tpl.errors|striptags }}</div>
          {% else %}
            <div class="form-text">Ejemplo:
              <code>{% verbatim %}Tu auto está listo • {{empresa.nombre}}{% endverbatim %}</code>
            </div>
          {% endif %}
        </div>

        <div class="mt-3">
          <label for="{{ form.cuerpo_tpl.id_for_label }}" class="form-label fw-semibold">Cuerpo del mensaje</label>
          {{ form.cuerpo_tpl }}
          {% if form.cuerpo_tpl.errors %}
            <div class="invalid-feedback d-block">{{ form.cuerpo_tpl.errors|striptags }}</div>
          {% else %}
            <div class="form-text">
              Podés usar variables como:
              <code>{% verbatim %}{{cliente.nombre}}{% endverbatim %}</code>,
              <code>{% verbatim %}{{vehiculo.patente}}{% endverbatim %}</code>,
              <code>{% verbatim %}{{venta.total}}{% endverbatim %}</code>.
            </div>
          {% endif %}
        </div>

        <!-- Ayuda memoria -->
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <h2 class="h6 text-uppercase text-muted mb-2">Variables disponibles</h2>
            <div class="bg-light border rounded p-2 small">
              <div><code>{% verbatim %}{{cliente.nombre}}{% endverbatim %}</code>,
                  <code>{% verbatim %}{{cliente.apellido}}{% endverbatim %}</code>,
                  <code>{% verbatim %}{{cliente.telefono}}{% endverbatim %}</code></div>
              <div><code>{% verbatim %}{{vehiculo.patente}}{% endverbatim %}</code>,
                  <code>{% verbatim %}{{vehiculo.marca}}{% endverbatim %}</code>,
                  <code>{% verbatim %}{{vehiculo.modelo}}{% endverbatim %}</code></div>
              <div><code>{% verbatim %}{{venta.id}}{% endverbatim %}</code>,
                  <code>{% verbatim %}{{venta.total}}{% endverbatim %}</code>,
                  <code>{% verbatim %}{{venta.estado}}{% endverbatim %}</code></div>
              <div><code>{% verbatim %}{{empresa.nombre}}{% endverbatim %}</code>,
                  <code>{% verbatim %}{{sucursal.nombre}}{% endverbatim %}</code></div>
              <div><code>{% verbatim %}{{venta.comprobante_url}}{% endverbatim %}</code>,
                  <code>{% verbatim %}{{nota_extra}}{% endverbatim %}</code></div>
            </div>
            <p class="small text-muted mt-2 mb-0">
              El render es de texto plano (sin HTML). Los faltantes se reemplazan por “—”.
            </p>
          </div>
        </div>

        <div class="mt-3 form-check">
          {{ form.activo }}
          <label class="form-check-label fw-semibold" for="{{ form.activo.id_for_label }}">Plantilla activa</label>
          {% if form.activo.errors %}
            <div class="invalid-feedback d-block">{{ form.activo.errors|striptags }}</div>
          {% endif %}
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between">
        <a href="{% url 'notifications:templates_list' %}" class="btn btn-outline-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>Guardar</button>
      </div>
    </div>
  </form>
</div>
{% endblock %}
