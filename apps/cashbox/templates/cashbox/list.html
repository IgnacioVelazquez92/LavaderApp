{% extends "base_auth.html" %}

{% block title %}Turnos de Caja{% endblock %}

{% block content %}
<div class="container-xxl py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3 mb-0">Turnos de Caja</h1>
    <div>
      <a href="{% url 'cashbox:z' %}" class="btn btn-outline-info">
        Ver Cierre Z
      </a>
      {% if turno_abierto %}
        <a href="{% url 'cashbox:detalle' id=turno_abierto.id %}" class="btn btn-outline-primary">
          Ver turno abierto
        </a>
        <a href="{% url 'cashbox:cerrar' id=turno_abierto.id %}" class="btn btn-primary ms-2">
          Cerrar turno
        </a>
      {% else %}
        <a href="{% url 'cashbox:abrir' %}" class="btn btn-primary">Abrir turno</a>
      {% endif %}
    </div>
  </div>

  {# Filtros simples (opcional) #}
  <form method="get" class="row g-2 mb-3">
    <div class="col-auto">
      <select name="sucursal" class="form-select">
        <option value="">Todas las sucursales</option>
        {% for s in sucursales %}
          <option value="{{ s.id }}" {% if s.id|stringformat:"s" == sucursal_filtro %}selected{% endif %}>
            {{ s.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <input type="date" name="desde" value="{{ desde }}" class="form-control" placeholder="Desde">
    </div>
    <div class="col-auto">
      <input type="date" name="hasta" value="{{ hasta }}" class="form-control" placeholder="Hasta">
    </div>
    <div class="col-auto">
      <select name="abiertos" class="form-select">
        <option value="">Todos</option>
        <option value="1" {% if abiertos == "1" %}selected{% endif %}>Solo abiertos</option>
        <option value="0" {% if abiertos == "0" %}selected{% endif %}>Solo cerrados</option>
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-secondary" type="submit">Filtrar</button>
    </div>
  </form>

  <div class="card">
    <div class="table-responsive">
      <table class="table table-sm table-striped mb-0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Sucursal</th>
            <th>Apertura</th>
            <th>Cierre</th>
            <th>Abierto por</th>
            <th>Cerrado por</th>
            <th class="text-center">Estado</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for turno in turnos %}
            <tr>
              <td>{{ turno.id }}</td>
              <td>{{ turno.sucursal.nombre }}</td>
              <td>{{ turno.abierto_en|date:"Y-m-d H:i" }}</td>
              <td>{% if turno.cerrado_en %}{{ turno.cerrado_en|date:"Y-m-d H:i" }}{% else %}—{% endif %}</td>
              <td>
                {% if turno.abierto_por.get_full_name %}
                  {{ turno.abierto_por.get_full_name }}
                {% else %}
                  {{ turno.abierto_por.email }}
                {% endif %}
              </td>
              <td>
                {% if turno.cerrado_por %}
                  {% if turno.cerrado_por.get_full_name %}
                    {{ turno.cerrado_por.get_full_name }}
                  {% else %}
                    {{ turno.cerrado_por.email }}
                  {% endif %}
                {% else %}—{% endif %}
              </td>
              <td class="text-center">
                {% if turno.cerrado_en %}
                  <span class="badge bg-success">CERRADO</span>
                {% else %}
                  <span class="badge bg-warning text-dark">ABIERTO</span>
                {% endif %}
              </td>

              <td class="text-nowrap text-end">
                <a href="{% url 'cashbox:detalle' id=turno.id %}" class="btn btn-sm btn-outline-secondary">Ver</a>
                {% if turno.esta_abierto %}
                  <a href="{% url 'cashbox:cerrar' id=turno.id %}" class="btn btn-sm btn-primary">Cerrar</a>
                {% endif %}
              </td>

            </tr>
          {% empty %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">No hay turnos para los filtros seleccionados.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
      <div class="card-footer">
        {% include "includes/_pagination.html" %}
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
