{# apps/saas/templates/saas/panel.html #}
{% extends "base_auth.html" %}
{% load static %}

{% block title %}Mi Plan{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Header -->
  <div class="d-flex flex-wrap align-items-end justify-content-between mb-3">
    <div>
      <h1 class="h3 mb-1">Mi Suscripción</h1>
      <p class="text-muted mb-0">Estado del plan de tu lavadero y uso de los límites.</p>
    </div>
    <div class="mt-2 mt-sm-0">
      <a class="btn btn-outline-primary" href="{% url 'saas:planes_public' %}">
        Ver planes y solicitar upgrade
      </a>
    </div>
  </div>

  {% if not snapshot.has_subscription %}
    <div class="alert alert-warning shadow-sm">
      <strong>No tenés un plan asignado.</strong>
      Contactá al administrador para habilitar tu suscripción.
    </div>
  {% else %}

    {# Avisos de estado globales #}
    {% if snapshot.estado == "suspendida" %}
      <div class="alert alert-danger shadow-sm">
        <strong>Suscripción suspendida.</strong> Algunas funciones pueden estar limitadas.
      </div>
    {% elif not snapshot.vigente %}
      <div class="alert alert-warning shadow-sm">
        <strong>Tu suscripción no está vigente.</strong>
        Revisá el vencimiento o contactá soporte para regularizar.
      </div>
    {% elif snapshot.payment_status == "trial" and snapshot.trial_ends_at %}
      <div class="alert alert-info shadow-sm">
        <strong>Estás en período de prueba.</strong> Finaliza el {{ snapshot.trial_ends_at }}.
      </div>
    {% endif %}

    <!-- Tarjeta del plan -->
    <div class="card shadow-sm mb-4">
      <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
        <div>
          <h4 class="card-title mb-1 d-flex align-items-center gap-2">
            {{ snapshot.plan.nombre }}
            {% if snapshot.vigente %}
              <span class="badge bg-success">Vigente</span>
            {% else %}
              <span class="badge bg-danger">No vigente</span>
            {% endif %}
            {% if snapshot.payment_status == "trial" %}
              <span class="badge bg-info text-dark">Trial</span>
            {% elif snapshot.payment_status == "paid" %}
              <span class="badge bg-primary">Pago al día</span>
            {% elif snapshot.payment_status == "unpaid" %}
              <span class="badge bg-secondary">Sin pago</span>
            {% endif %}
          </h4>
          <div class="small text-muted">
            Estado: {{ snapshot.estado|capfirst }} — Pago: {{ snapshot.payment_status|capfirst }}
          </div>
        </div>
        <div class="text-end ms-auto">
          <div class="fs-4 fw-bold mb-0">${{ snapshot.plan.precio_mensual }}</div>
          <div class="text-muted small">por mes</div>
        </div>
      </div>
      <div class="card-footer small text-muted d-flex flex-wrap gap-3">
        <span>Inicio: {{ snapshot.inicio }}</span>
        {% if snapshot.fin %}
          <span>Fin: {{ snapshot.fin }}</span>
        {% elif snapshot.trial_ends_at %}
          <span>Fin del trial: {{ snapshot.trial_ends_at }}</span>
        {% else %}
          <span>Sin vencimiento</span>
        {% endif %}
        {% if request.sucursal_activa %}
          <span class="ms-auto">Sucursal activa: <strong>{{ request.sucursal_activa.nombre }}</strong></span>
        {% endif %}
      </div>
    </div>

    <!-- Uso de límites -->
    <div class="row g-3">

      <!-- Sucursales -->
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <h6 class="fw-bold mb-0">Sucursales</h6>
              {% if usage.sucursales.limit %}
                {% if usage.sucursales.used >= usage.sucursales.limit %}
                  <span class="badge bg-danger">Límite alcanzado</span>
                {% elif usage.sucursales.used >= usage.sucursales.limit|add:"-1" %}
                  <span class="badge bg-warning text-dark">Cerca del límite</span>
                {% endif %}
              {% endif %}
            </div>

            {% if usage.sucursales.limit %}
              {% widthratio usage.sucursales.used usage.sucursales.limit 100 as suc_pct %}
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar
                            {% if usage.sucursales.used >= usage.sucursales.limit %}bg-danger
                            {% elif usage.sucursales.used >= usage.sucursales.limit|add:'-1' %}bg-warning
                            {% else %}bg-success{% endif %}"
                     role="progressbar"
                     style="width: {{ suc_pct }}%;"></div>
              </div>
              <p class="mb-0 small">{{ usage.sucursales.used }} / {{ usage.sucursales.limit }} usadas</p>
            {% else %}
              <p class="mb-0 small">{{ usage.sucursales.used }} sucursales</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Usuarios (empresa) -->
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <h6 class="fw-bold mb-0">Usuarios (empresa)</h6>
              {% if usage.usuarios_empresa.limit %}
                {% if usage.usuarios_empresa.used >= usage.usuarios_empresa.limit %}
                  <span class="badge bg-danger">Límite alcanzado</span>
                {% elif usage.usuarios_empresa.used >= usage.usuarios_empresa.limit|add:"-1" %}
                  <span class="badge bg-warning text-dark">Cerca del límite</span>
                {% endif %}
              {% endif %}
            </div>

            {% if usage.usuarios_empresa.limit %}
              {% widthratio usage.usuarios_empresa.used usage.usuarios_empresa.limit 100 as usr_pct %}
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar
                            {% if usage.usuarios_empresa.used >= usage.usuarios_empresa.limit %}bg-danger
                            {% elif usage.usuarios_empresa.used >= usage.usuarios_empresa.limit|add:'-1' %}bg-warning
                            {% else %}bg-success{% endif %}"
                     role="progressbar"
                     style="width: {{ usr_pct }}%;"></div>
              </div>
              <p class="mb-0 small">{{ usage.usuarios_empresa.used }} / {{ usage.usuarios_empresa.limit }} activos</p>
            {% else %}
              <p class="mb-0 small">{{ usage.usuarios_empresa.used }} usuarios activos</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Empleados en sucursal activa -->
      {% if usage.empleados_sucursal %}
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <h6 class="fw-bold mb-0">Empleados en esta sucursal</h6>
              {% if usage.empleados_sucursal.limit %}
                {% if usage.empleados_sucursal.used >= usage.empleados_sucursal.limit %}
                  <span class="badge bg-danger">Límite alcanzado</span>
                {% elif usage.empleados_sucursal.used >= usage.empleados_sucursal.limit|add:"-1" %}
                  <span class="badge bg-warning text-dark">Cerca del límite</span>
                {% endif %}
              {% endif %}
            </div>

            {% if usage.empleados_sucursal.limit %}
              {% widthratio usage.empleados_sucursal.used usage.empleados_sucursal.limit 100 as emp_pct %}
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar
                            {% if usage.empleados_sucursal.used >= usage.empleados_sucursal.limit %}bg-danger
                            {% elif usage.empleados_sucursal.used >= usage.empleados_sucursal.limit|add:'-1' %}bg-warning
                            {% else %}bg-success{% endif %}"
                     role="progressbar"
                     style="width: {{ emp_pct }}%;"></div>
              </div>
              <p class="mb-0 small">{{ usage.empleados_sucursal.used }} / {{ usage.empleados_sucursal.limit }} empleados</p>
            {% else %}
              <p class="mb-0 small">{{ usage.empleados_sucursal.used }} empleados</p>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- CTA / Upsell -->
    <div class="mt-4">
      {# Importante: evitar 'or' con paréntesis. Usamos if/elif/else #}
      {% if not snapshot.vigente %}
        <div class="alert alert-info d-flex align-items-center justify-content-between shadow-sm">
          <div>
            <strong>¿Tu negocio está creciendo?</strong>
            Estás alcanzando los límites del plan <em>{{ snapshot.plan.nombre }}</em>.
          </div>
          <a href="{% url 'saas:planes_public' %}" class="btn btn-primary">Ver opciones de upgrade</a>
        </div>
      {% elif usage.sucursales.limit and usage.sucursales.used >= usage.sucursales.limit %}
        <div class="alert alert-info d-flex align-items-center justify-content-between shadow-sm">
          <div><strong>Más sucursales</strong>: superaste el límite de tu plan.</div>
          <a href="{% url 'saas:planes_public' %}" class="btn btn-primary">Ver planes</a>
        </div>
      {% elif usage.usuarios_empresa.limit and usage.usuarios_empresa.used >= usage.usuarios_empresa.limit %}
        <div class="alert alert-info d-flex align-items-center justify-content-between shadow-sm">
          <div><strong>Más usuarios</strong>: alcanzaste el máximo del plan.</div>
          <a href="{% url 'saas:planes_public' %}" class="btn btn-primary">Ver planes</a>
        </div>
      {% elif usage.empleados_sucursal and usage.empleados_sucursal.limit and usage.empleados_sucursal.used >= usage.empleados_sucursal.limit %}
        <div class="alert alert-info d-flex align-items-center justify-content-between shadow-sm">
          <div><strong>Más empleados por sucursal</strong>: llegaste al tope del plan.</div>
          <a href="{% url 'saas:planes_public' %}" class="btn btn-primary">Ver planes</a>
        </div>
      {% else %}
        <div class="text-center text-muted">
          Todo dentro de los límites del plan. ¡Seguimos acompañando tu crecimiento!
        </div>
      {% endif %}
    </div>

  {% endif %}
</div>
{% endblock %}
