{# apps/payments/templates/payments/form.html #}
{% extends "base_auth.html" %}
{% block title %}Registrar pago{% endblock %}

{% block content %}
<div class="container py-3">
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'sales:list' %}">Ventas</a></li>
      <li class="breadcrumb-item"><a href="{% url 'sales:detail' pk=venta.pk %}">Detalle</a></li>
      <li class="breadcrumb-item active" aria-current="page">Registrar pago</li>
    </ol>
  </nav>

  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="card">
        <div class="card-header fw-semibold">Registrar pago</div>
        <div class="card-body">

          {% if requiere_confirmacion %}
            <div class="alert alert-warning d-flex align-items-start">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <div>
                Estás registrando <strong>${{ monto_ingresado }}</strong> y el saldo actual es
                <strong>${{ saldo_actual }}</strong>.<br>
                ¿Querés aplicar la <strong>diferencia de ${{ diferencia_propina }}</strong> como <strong>propina</strong>?
              </div>
            </div>
          {% endif %}

          <form method="post" novalidate>
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label" for="id_medio">Medio</label>
              {{ form.medio }}
              {% if form.medio.errors %}<div class="invalid-feedback d-block">{{ form.medio.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_monto">Monto</label>
              {{ form.monto }}
              <div class="form-text">Saldo pendiente: <strong>${{ venta.saldo_pendiente }}</strong></div>
              {% if form.monto.errors %}<div class="invalid-feedback d-block">{{ form.monto.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3 form-check">
              {{ form.es_propina }} <label class="form-check-label" for="id_es_propina">Marcar como propina</label>
              {% if form.es_propina.errors %}<div class="invalid-feedback d-block">{{ form.es_propina.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_referencia">Referencia</label>
              {{ form.referencia }}
              {% if form.referencia.errors %}<div class="invalid-feedback d-block">{{ form.referencia.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_notas">Notas</label>
              {{ form.notas }}
              {% if form.notas.errors %}<div class="invalid-feedback d-block">{{ form.notas.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_idempotency_key">Clave de idempotencia (opcional)</label>
              {{ form.idempotency_key }}
              {% if form.idempotency_key.errors %}<div class="invalid-feedback d-block">{{ form.idempotency_key.errors|striptags }}</div>{% endif %}
            </div>

            {% if requiere_confirmacion %}
              <input type="hidden" name="confirmar_split" value="1">
              <div class="d-flex gap-2">
                <a href="{% url 'payments:create' venta_id=venta.pk %}" class="btn btn-outline-secondary">Volver y editar</a>
                <button type="submit" class="btn btn-primary">
                  Confirmar y aplicar diferencia como propina
                </button>
              </div>
            {% else %}
              <div class="d-grid">
                <button type="submit" class="btn btn-primary">Registrar pago</button>
              </div>
            {% endif %}
          </form>

        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="card">
        <div class="card-header fw-semibold">Resumen de venta</div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between">
              <span>Total</span><span class="fw-semibold">${{ venta.total }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Saldo pendiente</span><span class="fw-semibold">${{ venta.saldo_pendiente }}</span>
            </li>
          </ul>
          <div class="mt-3">
            <a href="{% url 'sales:detail' pk=venta.pk %}" class="btn btn-outline-secondary w-100">Volver al detalle</a>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
