{# apps/payments/templates/payments/form.html #}
{% extends "base_auth.html" %}
{% load i18n %}
{% block title %}{% trans "Registrar pago" %}{% endblock %}

{% block content %}
<div class="container py-3">
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'sales:list' %}">{% trans "Ventas" %}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'sales:detail' pk=venta.pk %}">{% trans "Detalle" %}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{% trans "Registrar pago" %}</li>
    </ol>
  </nav>

  <div class="d-flex justify-content-end gap-2 mb-2">
    {% if puede_configurar %}
      <a href="{% url 'payments:medios_list' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-gear"></i> {% trans "Configurar medios" %}
      </a>
    {% endif %}
  </div>

  {% if not puede_crear %}
    <div class="alert alert-warning d-flex align-items-start mb-3">
      <i class="bi bi-lock me-2"></i>
      <div>
        {% trans "No tenés permiso para registrar pagos. Si necesitás acceso, hablá con un administrador." %}
      </div>
    </div>
  {% endif %}

  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="card">
        <div class="card-header fw-semibold">{% trans "Registrar pago" %}</div>
        <div class="card-body">

          {# fallback server-side si el backend pidió confirmación #}
          {% if requiere_confirmacion %}
            <div class="alert alert-warning d-flex align-items-start">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <div>
                {% blocktrans with mi=monto_ingresado sa=saldo_actual dp=diferencia_propina %}
                  Estás registrando <strong>${{ mi }}</strong> y el saldo actual es
                  <strong>${{ sa }}</strong>.<br>
                  ¿Querés aplicar la <strong>diferencia de ${{ dp }}</strong> como <strong>propina</strong>?
                {% endblocktrans %}
              </div>
            </div>
          {% endif %}

          <form id="payment-form" method="post" novalidate data-saldo="{{ venta.saldo_pendiente }}">
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label" for="id_medio">{% trans "Medio" %}</label>
              {{ form.medio }}
              {% if form.medio.errors %}<div class="invalid-feedback d-block">{{ form.medio.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_monto">{% trans "Monto" %}</label>
              {{ form.monto }}
              <div class="form-text">
                {% trans "Saldo pendiente" %}: <strong>${{ venta.saldo_pendiente }}</strong>
              </div>
              {% if form.monto.errors %}<div class="invalid-feedback d-block">{{ form.monto.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3 form-check">
              {{ form.es_propina }}
              <label class="form-check-label" for="id_es_propina">{% trans "Marcar como propina" %}</label>
              {% if form.es_propina.errors %}<div class="invalid-feedback d-block">{{ form.es_propina.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_referencia">{% trans "Referencia" %}</label>
              {{ form.referencia }}
              {% if form.referencia.errors %}<div class="invalid-feedback d-block">{{ form.referencia.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_notas">{% trans "Notas" %}</label>
              {{ form.notas }}
              {% if form.notas.errors %}<div class="invalid-feedback d-block">{{ form.notas.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_idempotency_key">{% trans "Clave de idempotencia (opcional)" %}</label>
              {{ form.idempotency_key }}
              {% if form.idempotency_key.errors %}<div class="invalid-feedback d-block">{{ form.idempotency_key.errors|striptags }}</div>{% endif %}
            </div>

            {# oculto que controla el split en el backend #}
            <input type="hidden" name="confirmar_split" id="confirmar_split" value="{% if requiere_confirmacion %}1{% else %}0{% endif %}">

            {% if requiere_confirmacion %}
              <div class="d-flex gap-2">
                <a href="{% url 'payments:create' venta_id=venta.pk %}" class="btn btn-outline-secondary">
                  {% trans "Volver y editar" %}
                </a>
                <button type="submit" class="btn btn-primary" {% if not puede_crear %}disabled{% endif %}>
                  {% trans "Confirmar y aplicar diferencia como propina" %}
                </button>
              </div>
            {% else %}
              <div class="d-grid">
                <button type="submit" class="btn btn-primary" {% if not puede_crear %}disabled{% endif %}>
                  {% trans "Registrar pago" %}
                </button>
              </div>
            {% endif %}
          </form>

        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="card">
        <div class="card-header fw-semibold">{% trans "Resumen de venta" %}</div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between">
              <span>{% trans "Total" %}</span><span class="fw-semibold">${{ venta.total }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>{% trans "Saldo pendiente" %}</span><span class="fw-semibold">${{ venta.saldo_pendiente }}</span>
            </li>
          </ul>
          <div class="mt-3">
            <a href="{% url 'sales:detail' pk=venta.pk %}" class="btn btn-outline-secondary w-100">
              {% trans "Volver al detalle" %}
            </a>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

{# ---------------- MODAL / JS (solo front-end) ---------------- #}
<div class="modal fade" id="modalConfirmOverpay" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "Aplicar diferencia como propina" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Cerrar' %}"></button>
      </div>
      <div class="modal-body">
        {% blocktrans %}
          Estás registrando <strong>$<span id="montoIngresado"></span></strong> y el saldo actual es
          <strong>$<span id="saldoActual"></span></strong>.<br>
          La <strong>diferencia</strong> es <strong>$<span id="diferenciaPropina"></span></strong>.<br><br>
          ¿Querés aplicar esa diferencia como <strong>propina</strong>?
        {% endblocktrans %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">{% trans "Volver y editar" %}</button>
        <button type="button" class="btn btn-primary" id="btnConfirmarSplit">{% trans "Confirmar" %}</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const form = document.getElementById('payment-form');
  if (!form) return;

  const inputMonto = document.getElementById('id_monto');
  const inputEsPropina = document.getElementById('id_es_propina');
  const hiddenSplit = document.getElementById('confirmar_split');
  const saldo = parseFloat(String(form.dataset.saldo).replace(',', '.')) || 0;

  // Utils de parseo tolerante (soporta 12.345,67 y 12345.67)
  function parseDecimal(value) {
    if (typeof value !== 'string') return Number(value) || 0;
    const v = value.trim();
    if (v.indexOf(',') >= 0 && v.indexOf('.') >= 0) {
      return parseFloat(v.replace(/\./g, '').replace(',', '.')) || 0;
    }
    if (v.indexOf(',') >= 0) return parseFloat(v.replace(',', '.')) || 0;
    return parseFloat(v) || 0;
  }

  // Bootstrap modal
  let bsModal;
  function getModal() {
    const el = document.getElementById('modalConfirmOverpay');
    if (!bsModal) bsModal = new bootstrap.Modal(el);
    return { el, bsModal };
  }

  form.addEventListener('submit', function(ev) {
    // Si el backend ya pidió confirmación, dejamos pasar
    if (hiddenSplit && hiddenSplit.value === '1') return;

    const monto = parseDecimal(inputMonto ? inputMonto.value : '0');
    const esPropina = !!(inputEsPropina && inputEsPropina.checked);

    // Mostrar modal SOLO si es sobrepago y no marcaron propina manual
    if (!esPropina && monto > saldo && saldo > 0) {
      ev.preventDefault();

      document.getElementById('montoIngresado').textContent = monto.toFixed(2);
      document.getElementById('saldoActual').textContent = saldo.toFixed(2);
      document.getElementById('diferenciaPropina').textContent = (monto - saldo).toFixed(2);

      const { bsModal } = getModal();
      bsModal.show();

      const btn = document.getElementById('btnConfirmarSplit');
      const handler = function() {
        hiddenSplit.value = '1';
        bsModal.hide();
        btn.removeEventListener('click', handler);
        form.submit();
      };
      btn.addEventListener('click', handler, { once: true });
    }
  }, false);
})();
</script>
{% endblock %}
