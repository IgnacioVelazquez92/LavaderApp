{# apps/payments/templates/payments/form.html #}
{% extends "base_auth.html" %}
{% load i18n %}
{% block title %}{% trans "Registrar pago" %}{% endblock %}

{% block content %}
<div class="container py-3">
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'sales:list' %}">{% trans "Ventas" %}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'sales:detail' pk=venta.pk %}">{% trans "Detalle" %}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{% trans "Registrar pago" %}</li>
    </ol>
  </nav>

  <div class="d-flex justify-content-end gap-2 mb-2">
    {% if puede_configurar %}
      <a href="{% url 'payments:medios_list' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-gear"></i> {% trans "Configurar medios" %}
      </a>
    {% endif %}
  </div>

  {% if not puede_crear %}
    <div class="alert alert-warning d-flex align-items-start mb-3">
      <i class="bi bi-lock me-2"></i>
      <div>{% trans "No tenés permiso para registrar pagos. Si necesitás acceso, hablá con un administrador." %}</div>
    </div>
  {% endif %}

  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="card">
        <div class="card-header fw-semibold">{% trans "Registrar pago" %}</div>
        <div class="card-body">

          {# Sin alertas ni botones de confirmación en body. Todo por modal. #}
          <form id="payment-form"
                method="post"
                novalidate
                data-saldo="{{ venta.saldo_pendiente }}"
                {% if requiere_confirmacion %}
                  data-reqconf="1"
                  data-mi="{{ monto_ingresado }}"
                  data-sa="{{ saldo_actual }}"
                  data-dp="{{ diferencia_propina }}"
                {% else %}
                  data-reqconf="0"
                {% endif %}>
            {% csrf_token %}

            {# Se marca en 1 sólo al confirmar en el modal #}
            <input type="hidden" name="confirmar_split" id="confirmar_split" value="0">

            <div class="mb-3">
              <label class="form-label" for="id_medio">{% trans "Medio" %}</label>
              {{ form.medio }}
              {% if form.medio.errors %}<div class="invalid-feedback d-block">{{ form.medio.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_monto">{% trans "Monto" %}</label>
              {{ form.monto }}
              <div class="form-text">
                {% trans "Saldo pendiente" %}: <strong>${{ venta.saldo_pendiente }}</strong>
              </div>
              {% if form.monto.errors %}<div class="invalid-feedback d-block">{{ form.monto.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_referencia">{% trans "Referencia / N° de operación (opcional)" %}</label>
              {{ form.referencia }}
              <div class="form-text">
                {% trans "Ej.: ID de transacción de MercadoPago/Stripe, Nº de operación bancaria, últimos 4 dígitos de la tarjeta, etc." %}
              </div>
              {% if form.referencia.errors %}<div class="invalid-feedback d-block">{{ form.referencia.errors|striptags }}</div>{% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_notas">{% trans "Notas" %}</label>
              {{ form.notas }}
              {% if form.notas.errors %}<div class="invalid-feedback d-block">{{ form.notas.errors|striptags }}</div>{% endif %}
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary" {% if not puede_crear %}disabled{% endif %}>
                {% trans "Registrar pago" %}
              </button>
            </div>
          </form>

        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="card">
        <div class="card-header fw-semibold">{% trans "Resumen de venta" %}</div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between">
              <span>{% trans "Total" %}</span><span class="fw-semibold">${{ venta.total }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>{% trans "Saldo pendiente" %}</span><span class="fw-semibold">${{ venta.saldo_pendiente }}</span>
            </li>
          </ul>
          <div class="mt-3">
            <a href="{% url 'sales:detail' pk=venta.pk %}" class="btn btn-outline-secondary w-100">
              {% trans "Volver al detalle" %}
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{# ---------------- MODAL / JS ---------------- #}
<div class="modal fade" id="modalConfirmOverpay" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "Aplicar diferencia como propina" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Cerrar' %}"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">
          {% blocktrans %}
            Estás registrando <strong>$<span id="montoIngresado"></span></strong> y el saldo actual es
            <strong>$<span id="saldoActual"></span></strong>.<br>
            La <strong>diferencia</strong> es <strong>$<span id="diferenciaPropina"></span></strong>.<br><br>
            ¿Querés aplicar esa diferencia como <strong>propina</strong>?
          {% endblocktrans %}
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">{% trans "Volver y editar" %}</button>
        <button type="button" class="btn btn-primary" id="btnConfirmarSplit">{% trans "Confirmar" %}</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  function onDOMReady(cb) {
    if (document.readyState !== 'loading') cb();
    else document.addEventListener('DOMContentLoaded', cb, { once: true });
  }
  function whenBootstrapReady(cb) {
    if (window.bootstrap && typeof window.bootstrap.Modal === 'function') { cb(); return; }
    const started = Date.now();
    const iv = setInterval(() => {
      if (window.bootstrap && typeof window.bootstrap.Modal === 'function') { clearInterval(iv); cb(); }
      else if (Date.now() - started > 4000) { clearInterval(iv); }
    }, 30);
  }
  function parseDecimal(value) {
    if (typeof value !== 'string') return Number(value) || 0;
    const v = value.trim();
    if (v.indexOf(',') >= 0 && v.indexOf('.') >= 0) return parseFloat(v.replace(/\./g, '').replace(',', '.')) || 0;
    if (v.indexOf(',') >= 0) return parseFloat(v.replace(',', '.')) || 0;
    return parseFloat(v) || 0;
  }

  function init() {
    const form = document.getElementById('payment-form');
    if (!form) return;

    const inputMonto  = document.getElementById('id_monto');
    const hiddenSplit = document.getElementById('confirmar_split');
    const saldo       = parseFloat(String(form.dataset.saldo).replace(',', '.')) || 0;

    const reqconf  = form.dataset.reqconf === '1';
    const miServer = form.dataset.mi ? parseFloat(String(form.dataset.mi).toString().replace(',', '.')) : null;
    const saServer = form.dataset.sa ? parseFloat(String(form.dataset.sa).toString().replace(',', '.')) : null;
    const dpServer = form.dataset.dp ? parseFloat(String(form.dataset.dp).toString().replace(',', '.')) : null;

    function getModal() {
      const el = document.getElementById('modalConfirmOverpay');
      if (!el) return null;
      return new window.bootstrap.Modal(el);
    }
    function fillAndShowModal(monto, saldoActual, diferencia) {
      const montoEl = document.getElementById('montoIngresado');
      const saldoEl = document.getElementById('saldoActual');
      const difEl   = document.getElementById('diferenciaPropina');
      if (montoEl) montoEl.textContent = Number(monto).toFixed(2);
      if (saldoEl) saldoEl.textContent = Number(saldoActual).toFixed(2);
      if (difEl)   difEl.textContent   = Number(diferencia).toFixed(2);
      const modal = getModal();
      if (!modal) return;

      const oldBtn = document.getElementById('btnConfirmarSplit');
      const newBtn = oldBtn.cloneNode(true);
      oldBtn.replaceWith(newBtn);

      newBtn.addEventListener('click', function() {
        hiddenSplit.value = '1';
        modal.hide();
        form.submit();
      }, { once: true });

      modal.show();
    }

    // Auto-modal del backend (incluye el caso saldo=0)
    if (reqconf && miServer != null && saServer != null && dpServer != null) {
      fillAndShowModal(miServer, saServer, dpServer);
    }

    // Modal en submit si el front detecta sobrepago con saldo>0
    form.addEventListener('submit', function(ev) {
      if (hiddenSplit && hiddenSplit.value === '1') return;
      const monto = parseDecimal(inputMonto ? inputMonto.value : '0');
      if (monto > saldo && saldo > 0) {
        ev.preventDefault();
        fillAndShowModal(monto, saldo, (monto - saldo));
      }
    }, false);
  }

  onDOMReady(function(){ whenBootstrapReady(init); });
})();
</script>
{% endblock %}
