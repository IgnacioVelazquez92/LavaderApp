{# templates/org/empleados.html #}
{% extends "base_auth.html" %}
{% load org_perms %}
{% block title %}Empleados — Mi Lavadero{% endblock %}

{% block content %}
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-3">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb small mb-2">
          <li class="breadcrumb-item"><a href="{% url 'home' %}">Inicio</a></li>
          <li class="breadcrumb-item"><a href="{% url 'org:empresas' %}">Mi lavadero</a></li>
          <li class="breadcrumb-item active" aria-current="page">Empleados</li>
        </ol>
      </nav>
      <h1 class="h3 mb-1">Empleados</h1>
      <p class="text-body-secondary mb-0">Gestioná los usuarios que pueden operar en tu lavadero. Asignales un <strong>rol</strong> y una <strong>sucursal</strong>.</p>
    </div>
    <div class="mt-3 mt-md-0">
      {% can "org.empleados.manage" as puede_gestionar %}
      {% if puede_gestionar %}
        <a href="{% url 'org:empleado_nuevo' %}" class="btn btn-primary">
          <i class="bi bi-person-plus me-1"></i> Nuevo empleado
        </a>
      {% endif %}
    </div>
  </div>

  {% if empleados %}
    <div class="card border">
      <div class="card-body">
        <div class="row g-2 align-items-center mb-3">
          <div class="col-sm-6">
            <label for="filtro" class="form-label mb-0 small text-body-secondary">Buscar</label>
            <input id="filtro" type="search" class="form-control" placeholder="Filtrar por email, rol o sucursal…" autocomplete="off">
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle" id="tabla-empleados">
            <thead class="table-light">
              <tr>
                <th scope="col">Usuario</th>
                <th scope="col" class="d-none d-md-table-cell">Último ingreso</th>
                <th scope="col">Rol / Estado</th>
                <th scope="col">Sucursal</th>
                <th scope="col" class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for m in empleados %}
              <tr>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <div class="rounded-circle bg-light border d-inline-flex justify-content-center align-items-center" style="width:36px;height:36px;">
                      <span class="small text-muted">{{ m.user.email|first|upper }}</span>
                    </div>
                    <div class="d-flex flex-column">
                      <strong class="small">{{ m.user.email }}</strong>
                      <span class="text-body-secondary small">{{ m.empresa.nombre }}</span>
                    </div>
                  </div>
                </td>

                <td class="d-none d-md-table-cell">
                  <span class="small text-body-secondary">
                    {% if m.user.last_login %}{{ m.user.last_login|date:"d/m/Y H:i" }}{% else %}—{% endif %}
                  </span>
                </td>

                <td>
                  {% if m.rol == "admin" %}
                    <span class="badge text-bg-primary">Admin</span>
                  {% else %}
                    <span class="badge text-bg-success">Operador</span>
                  {% endif %}
                  {% if m.is_owner %}
                    <span class="badge text-bg-info ms-1">Propietario</span>
                  {% endif %}
                  {% if not m.activo %}
                    <span class="badge text-bg-secondary ms-1">Deshabilitado</span>
                  {% endif %}
                </td>

                <td>
                  <span class="small">{% if m.sucursal_asignada %}{{ m.sucursal_asignada.nombre }}{% else %}—{% endif %}</span>
                </td>

                <td class="text-end">
                  {% can "org.empleados.manage" as puede_gestionar %}
                  {% if puede_gestionar and not m.is_owner and m.user_id != request.user.id %}
                    <div class="btn-group">
                      <a href="{% url 'org:empleado_editar' m.pk %}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-pencil-square"></i> Editar
                      </a>

                      <!-- Reset pass (modal abre form POST) -->
                      <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalReset{{ m.pk }}">
                        <i class="bi bi-shield-lock"></i> Reset
                      </button>

                      <!-- Toggle activo -->
                      <button type="button" class="btn btn-sm {% if m.activo %}btn-outline-secondary{% else %}btn-outline-success{% endif %}"
                              data-bs-toggle="modal" data-bs-target="#modalToggle{{ m.pk }}">
                        {% if m.activo %}<i class="bi bi-pause-circle"></i> Deshabilitar{% else %}<i class="bi bi-play-circle"></i> Habilitar{% endif %}
                      </button>

                      <!-- Eliminar membresía -->
                      <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalEliminar{{ m.pk }}">
                        <i class="bi bi-trash"></i> Eliminar
                      </button>

                      {# (Opcional) Eliminar usuario del sistema completo — requiere permiso más fino #}
                      {% can "org.empleados.destroy_user" as puede_borrar_usuario %}
                      {% if puede_borrar_usuario %}
                        <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalDestroyUser{{ m.pk }}">
                          <i class="bi bi-person-x"></i> Borrar usuario
                        </button>
                      {% endif %}
                    </div>
                  {% else %}
                    <span class="text-body-secondary small">—</span>
                  {% endif %}
                </td>
              </tr>

              {# -------------------- Modales (POST + CSRF) -------------------- #}

              <!-- Modal Reset Pass -->
              <div class="modal fade" id="modalReset{{ m.pk }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <form method="post" action="{% url 'org:empleado_reset_pass' m.pk %}">
                      {% csrf_token %}
                      <div class="modal-header">
                        <h5 class="modal-title">Resetear contraseña</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                      </div>
                      <div class="modal-body">
                        <p class="mb-0">¿Resetear la contraseña de <strong>{{ m.user.email }}</strong>? Se establecerá una clave temporal.</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">Resetear</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Modal Toggle Activo -->
              <div class="modal fade" id="modalToggle{{ m.pk }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <form method="post" action="{% url 'org:empleado_toggle' m.pk %}">
                      {% csrf_token %}
                      <div class="modal-header">
                        <h5 class="modal-title">{% if m.activo %}Deshabilitar{% else %}Habilitar{% endif %} empleado</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                      </div>
                      <div class="modal-body">
                        {% if m.activo %}
                          <p class="mb-0">¿Deshabilitar a <strong>{{ m.user.email }}</strong>? No podrá operar en esta empresa hasta volver a habilitarlo.</p>
                        {% else %}
                          <p class="mb-0">¿Habilitar nuevamente a <strong>{{ m.user.email }}</strong>?</p>
                        {% endif %}
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn {% if m.activo %}btn-secondary{% else %}btn-success{% endif %}">
                          {% if m.activo %}Deshabilitar{% else %}Habilitar{% endif %}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Modal Eliminar membresía -->
              <div class="modal fade" id="modalEliminar{{ m.pk }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <form method="post" action="{% url 'org:empleado_eliminar' m.pk %}">
                      {% csrf_token %}
                      <div class="modal-header">
                        <h5 class="modal-title">Eliminar acceso</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                      </div>
                      <div class="modal-body">
                        <p class="mb-2">¿Eliminar el acceso de <strong>{{ m.user.email }}</strong> a <strong>{{ m.empresa.nombre }}</strong>?</p>
                        <p class="small text-body-secondary mb-0">Esto <strong>no borra</strong> el usuario del sistema, solo su membresía en esta empresa.</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              {# (Opcional) Modal Borrar usuario completo del sistema #}
              {% can "org.empleados.destroy_user" as puede_borrar_usuario %}
              {% if puede_borrar_usuario %}
              <div class="modal fade" id="modalDestroyUser{{ m.pk }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <form method="post" action="{% url 'org:empleado_destroy_user' m.pk %}">
                      {% csrf_token %}
                      <div class="modal-header">
                        <h5 class="modal-title">Borrar usuario del sistema</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                      </div>
                      <div class="modal-body">
                        <p class="mb-2">Esta acción <strong>borra el usuario</strong> <strong>{{ m.user.email }}</strong> del sistema (no solo su acceso a esta empresa).</p>
                        <p class="small text-body-secondary mb-0">Se cerrarán todas sus sesiones activas. Las ventas históricas permanecen asociadas a la empresa.</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Borrar usuario</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              {% endif %}

              {% endfor %}
            </tbody>
          </table>
        </div>

        <p class="small text-body-secondary mt-3 mb-0">
          Tip: asigná <strong>rol</strong> y <strong>sucursal</strong> para que el empleado entre directo a su contexto de trabajo.
        </p>
      </div>
    </div>
  {% else %}
    <div class="card border text-center py-5">
      <div class="card-body">
        <div class="mb-2">
          <i class="bi bi-people display-6 text-body-secondary"></i>
        </div>
        <h2 class="h5">Todavía no agregaste empleados</h2>
        <p class="text-body-secondary mb-3">Creá usuarios para tu equipo y asignales su sucursal y rol.</p>
        {% can "org.empleados.manage" as puede_gestionar %}
        {% if puede_gestionar %}
          <a href="{% url 'org:empleado_nuevo' %}" class="btn btn-primary">
            <i class="bi bi-person-plus me-1"></i> Nuevo empleado
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
<script>
  // Filtro de tabla simple (cliente)
  (function () {
    const filtro = document.getElementById('filtro');
    const rows = document.querySelectorAll('#tabla-empleados tbody tr');
    if (!filtro || !rows.length) return;
    filtro.addEventListener('input', function () {
      const q = (this.value || '').toLowerCase();
      rows.forEach(tr => {
        const text = tr.innerText.toLowerCase();
        tr.style.display = text.includes(q) ? '' : 'none';
      });
    });
  })();
</script>
{% endblock %}
