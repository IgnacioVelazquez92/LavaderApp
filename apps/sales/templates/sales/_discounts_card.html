{# apps/sales/templates/sales/_discounts_card.html #}
{# apps/sales/templates/sales/_discounts_card.html #}
<div class="card mb-3">
  <div class="card-header d-flex align-items-center justify-content-between">
    <span class="fw-semibold">
      <i class="bi bi-tags"></i> Descuentos y promociones
    </span>

    <div class="btn-group" role="group" aria-label="Acciones descuentos">
      <!-- Descuento por venta -->
      <button
        type="button"
        class="btn btn-sm btn-outline-primary"
        data-bs-toggle="modal"
        data-bs-target="#mdlDiscountOrder"
        {% if not puede_agregar_descuento or not descuentos_habilitados %}disabled title="No habilitado en este estado o por permisos."{% endif %}
      >
        <i class="bi bi-percent"></i> Descuento (venta)
      </button>

      <!-- Descuento por ítem -->
      <button
        type="button"
        class="btn btn-sm btn-outline-primary"
        data-bs-toggle="modal"
        data-bs-target="#mdlDiscountItem"
        {% if not puede_agregar_descuento or not descuentos_habilitados %}disabled title="No habilitado en este estado o por permisos."{% endif %}
      >
        <i class="bi bi-percent"></i> Descuento (ítem)
      </button>

      <!-- Promo por venta -->
      <button
        type="button"
        class="btn btn-sm btn-outline-success"
        data-bs-toggle="modal"
        data-bs-target="#mdlPromoOrder"
        {% if not puede_aplicar_promo or not descuentos_habilitados %}disabled title="No habilitado en este estado o por permisos."{% endif %}
      >
        <i class="bi bi-lightning"></i> Promo (venta)
      </button>

      <!-- Promo por ítem -->
      <button
        type="button"
        class="btn btn-sm btn-outline-success"
        data-bs-toggle="modal"
        data-bs-target="#mdlPromoItem"
        {% if not puede_aplicar_promo or not descuentos_habilitados %}disabled title="No habilitado en este estado o por permisos."{% endif %}
      >
        <i class="bi bi-lightning"></i> Promo (ítem)
      </button>

      <!-- Gestionar promociones -->
      {% if puede_gestionar_promos %}
        <a href="{{ promos_list_url }}" class="btn btn-sm btn-outline-dark">
          <i class="bi bi-gear"></i> Gestionar
        </a>
      {% else %}
        <button type="button" class="btn btn-sm btn-outline-dark" disabled
                data-bs-toggle="tooltip" data-bs-title="No tenés permisos para gestionar promociones.">
          <i class="bi bi-gear"></i> Gestionar
        </button>
      {% endif %}
    </div>
  </div>

  <div class="card-body p-0">
    {% if ajustes %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 120px;">Tipo</th>
              <th style="width: 120px;">Modo</th>
              <th style="width: 120px;" class="text-end">Valor</th>
              <th>Motivo / Promoción</th>
              <th style="width: 220px;">Ítem</th>
              <th style="width: 140px;">Origen</th>
              <th style="width: 70px;" class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for adj in ajustes %}
              <tr>
                <td>
                  {% if adj.kind == 'item' %}
                    <span class="badge bg-secondary">Por ítem</span>
                  {% else %}
                    <span class="badge bg-primary">Por venta</span>
                  {% endif %}
                </td>
                <td>
                  {% if adj.mode == 'percent' %}
                    <span class="badge bg-info text-dark">%</span>
                  {% else %}
                    <span class="badge bg-info text-dark">$</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  {% if adj.mode == 'percent' %}{{ adj.value }}%{% else %}${{ adj.value }}{% endif %}
                </td>
                <td class="text-wrap">
                  {% if adj.promotion %}
                    <i class="bi bi-lightning-charge"></i>
                    {{ adj.motivo|default_if_none:'' }} ({{ adj.promotion.nombre }})
                  {% else %}
                    {{ adj.motivo|default_if_none:'' }}
                  {% endif %}
                </td>
                <td>
                  {% if adj.item %}
                    <div class="small">
                      <div class="fw-semibold">{{ adj.item.servicio.nombre }}</div>
                      <div class="text-muted">x{{ adj.item.cantidad }} · ${{ adj.item.precio_unitario }}</div>
                    </div>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td>
                  {% if adj.source == 'manual' %}
                    <span class="badge bg-dark-subtle text-dark border">Manual</span>
                  {% elif adj.source == 'promo' %}
                    <span class="badge bg-success">Promo</span>
                  {% elif adj.source == 'payment' %}
                    <span class="badge bg-warning text-dark">Por pago</span>
                  {% else %}
                    <span class="badge bg-light text-dark">Otro</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <form method="post" action="{% url 'sales:discount_delete' venta.id adj.id %}" class="d-inline">
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="btn btn-sm btn-outline-danger"
                      {% if not puede_quitar_descuento or not descuentos_habilitados %}disabled title="No habilitado en este estado o por permisos."{% endif %}
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-3 text-muted">
        <i class="bi bi-info-circle"></i> No hay descuentos ni promociones aplicados.
      </div>
    {% endif %}
  </div>

  <div class="card-footer d-flex justify-content-end gap-2">
    <div class="text-muted small">
      Edición {% if descuentos_habilitados %}<span class="text-success">habilitada</span>{% else %}<span class="text-danger">bloqueada</span>{% endif %} (solo en <em>borrador</em> / <em>en proceso</em>).
    </div>
  </div>
</div>


<!-- MODAL: Descuento por VENTA -->
<div class="modal fade" id="mdlDiscountOrder" tabindex="-1" aria-labelledby="mdlDiscountOrderLbl" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'sales:discount_add_order' venta.id %}" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="mdlDiscountOrderLbl"><i class="bi bi-percent"></i> Descuento a toda la venta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Modo</label>
          {{ order_discount_form.mode }}
        </div>
        <div class="mb-3">
          <label class="form-label">Valor</label>
          {{ order_discount_form.value }}
          <div class="form-text">Si es % se aplica sobre el subtotal tras descuentos por ítem.</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Motivo (opcional)</label>
          {{ order_discount_form.motivo }}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-success" {% if not puede_aplicar_promo or not descuentos_habilitados %}disabled{% endif %}>Aplicar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Descuento por ÍTEM -->
<div class="modal fade" id="mdlDiscountItem" tabindex="-1" aria-labelledby="mdlDiscountItemLbl" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'sales:discount_add_item' venta.id %}" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="mdlDiscountItemLbl"><i class="bi bi-percent"></i> Descuento por ítem</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Ítem</label>
          <select name="item_id" class="form-select" required>
            {% for it in venta_items %}
              <option value="{{ it.id }}">{{ it.servicio.nombre }} — x{{ it.cantidad }} · ${{ it.precio_unitario }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Modo</label>
          {{ item_discount_form.mode }}
        </div>
        <div class="mb-3">
          <label class="form-label">Valor</label>
          {{ item_discount_form.value }}
        </div>
        <div class="mb-3">
          <label class="form-label">Motivo (opcional)</label>
          {{ item_discount_form.motivo }}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-success" {% if not puede_aplicar_promo or not descuentos_habilitados %}disabled{% endif %}>Aplicar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Promo por VENTA -->
<div class="modal fade" id="mdlPromoOrder" tabindex="-1" aria-labelledby="mdlPromoOrderLbl" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'sales:promo_apply' venta.id %}" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="mdlPromoOrderLbl"><i class="bi bi-lightning"></i> Aplicar promoción (venta)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Promoción</label>
          <select name="promotion_id" class="form-select" required>
            {% for p in promos_order %}
              <option value="{{ p.id }}">{{ p.nombre }} — {% if p.mode == 'percent' %}{{ p.value }}%{% else %}${{ p.value }}{% endif %}</option>
            {% empty %}
              <option disabled>No hay promociones vigentes</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-success" {% if not puede_agregar_descuento or not descuentos_habilitados %}disabled{% endif %}>Aplicar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Promo por ÍTEM -->
<div class="modal fade" id="mdlPromoItem" tabindex="-1" aria-labelledby="mdlPromoItemLbl" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'sales:promo_apply' venta.id %}" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="mdlPromoItemLbl"><i class="bi bi-lightning"></i> Aplicar promoción (ítem)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Ítem</label>
          <select name="item_id" class="form-select" required>
            {% for it in venta_items %}
              <option value="{{ it.id }}">{{ it.servicio.nombre }} — x{{ it.cantidad }} · ${{ it.precio_unitario }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Promoción</label>
          <select name="promotion_id" class="form-select" required>
            {% for p in promos_item %}
              <option value="{{ p.id }}">{{ p.nombre }} — {% if p.mode == 'percent' %}{{ p.value }}%{% else %}${{ p.value }}{% endif %}</option>
            {% empty %}
              <option disabled>No hay promociones vigentes</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-success" {% if not puede_agregar_descuento or not descuentos_habilitados %}disabled{% endif %}>Aplicar</button>
      </div>
    </form>
  </div>
</div>
<script>
  document.addEventListener('shown.bs.modal', (e) => {
    const first = e.target.querySelector('input,select,textarea');
    first && first.focus();
  });
</script>