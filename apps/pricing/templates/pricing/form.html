{% extends "base_auth.html" %}
{% load static %}

{% block title %}Precios — {{ view.object|default_if_none:"Nuevo" }}{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h4 mb-0">
        {% if view.object %}Editar precio{% else %}Nuevo precio{% endif %}
      </h1>
      <div class="text-muted">Definí vigencias sin solapamientos, por Sucursal × Servicio × Tipo.</div>
    </div>
    <div>
      {# Botón Volver: respeta ?next si viene en la URL #}
      {% if request.GET.next %}
        <a class="btn btn-outline-secondary" href="{{ request.GET.next }}">Volver</a>
      {% else %}
        <a class="btn btn-outline-secondary" href="{% url 'pricing:list' %}">Volver</a>
      {% endif %}
    </div>
  </div>


  <form method="post" novalidate>
    {% csrf_token %}
    {# Mantener el retorno para BackUrlMixin #}
    {% if request.GET.next %}
      <input type="hidden" name="next" value="{{ request.GET.next }}">
    {% elif request.POST.next %}
      <input type="hidden" name="next" value="{{ request.POST.next }}">
    {% endif %}

    {# Errores no asociados a campos #}
    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        <ul class="mb-0">
          {% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}
        </ul>
      </div>
    {% endif %}

    {% include "pricing/_form_fields.html" %}

    <div class="d-flex gap-2 mt-3">
      {# Botón principal según permiso #}
      {% if view.object %}
        {# Editar #}
        {% if puede_editar %}
          <button type="submit" class="btn btn-primary">Guardar cambios</button>
        {% else %}
          <button type="button" class="btn btn-primary" disabled
                  data-bs-toggle="tooltip" data-bs-placement="left"
                  title="No tenés permisos para editar precios">
            Guardar cambios
          </button>
        {% endif %}
      {% else %}
        {# Crear #}
        {% if puede_crear %}
          <button type="submit" class="btn btn-primary">Crear precio</button>
        {% else %}
          <button type="button" class="btn btn-primary" disabled
                  data-bs-toggle="tooltip" data-bs-placement="left"
                  title="No tenés permisos para crear precios">
            Crear precio
          </button>
        {% endif %}
      {% endif %}

      {% if request.GET.next %}
        <a class="btn btn-outline-secondary" href="{{ request.GET.next }}">Cancelar</a>
      {% else %}
        <a class="btn btn-outline-secondary" href="{% url 'pricing:list' %}">Cancelar</a>
      {% endif %}
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    // Inicializa tooltips de Bootstrap si no estuvieran inicializados globalmente
    document.addEventListener('DOMContentLoaded', function () {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      tooltipTriggerList.forEach(function (el) { new bootstrap.Tooltip(el) })
    });
  </script>
{% endblock %}
